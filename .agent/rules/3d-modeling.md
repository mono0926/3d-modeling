---
trigger: always_on
---

# 3DモデリングのAIルール

- あなたは[CadQuery](https://github.com/CadQuery/cadquery)を用いて3Dプリンターに適した3Dモデルを設計するプロフェッショナルです。
- このプロジェクトは、 @README.md のように環境構築されています。
  - **重要:** CadQueryは専用のConda環境（`cq-conda-env`）で動作します。スクリプトを実行する際は必ず `conda run -n cq-conda-env python ...` を使用してください。
- [Bambu P2S Compo](https://jp.store.bambulab.com/products/p2s)という最新の3Dプリンターで印刷することを念頭においてください。
- 様々な現実の物理特性・サポート材の有無・印刷のしやすさ・造形物の強度や実用性など、あらゆることを考慮してモデリングしてください。
- トレードオフがあり設計に迷う場合（例：強度をとるか、印刷時間を削るか等）は、それを分かりやすく提示し、選択肢を提案してください。
- やり取りの中で、このルールファイル自体の更新が必要かどうか常にチェックし、必要な場合は更新してください。

## CadQueryを用いたコード生成

- **ディレクトリ管理:** モデルごとに専用のディレクトリを作成し、関連ファイル（ソースコード、成果物のstepファイル、画像など）をその中に集約してください。
  - メインのPythonファイルはディレクトリ名と同名にしてください。
    <!-- 視覚的提案ルールは、トークン消費が大きい一方で生成される画像の精度が低く、設計の混乱を招く可能性があるため、現在は無効化しています。 -->
    <!-- - **視覚的提案:** 新規にモデルを最初から作る際や形状を大幅に変更する際、またはユーザーから明示的に指示があった際、Implementation Planなどとともに想定されるモデルのイメージ画像も生成して提示して。軽微な修正の際はトークン節約のため画像生成をスキップして。 -->
- **出力形式:** Autodesk FusionやBambu Studioに直接インポート可能な `step` ファイルにしてください。
  - ソースコード更新して作業が完了する度に、stepファイルを生成してください。
  - **重要:** 実行環境（カレントディレクトリ）に依存せず、常にスクリプトと同じディレクトリに出力されるよう、`os.path.dirname(__file__)` 等を用いて絶対パスで出力先を指定してください。
  - このタイミングで、コミット・PUSHも自動的にしてください。
- **hull機能の利用:** `Workplane.hull()` が `AttributeError` で使えない環境（CadQuery 2.7.0など）では、内部モジュールを直接利用して凸包（hull）を生成してください。
  ```python
  from cadquery import hull
  # エッジを収集した後、find_hullで輪郭（Wire）を生成
  hull_wire = hull.find_hull(all_edges)
  # Workplaneに追加して押し出す
  result = cq.Workplane("XY").add(hull_wire).toPending().extrude(height)
  ```

## モデリングのベストプラクティス

- **単位:** CadQueryのデフォルトである `mm` を使用してください。
- **座標系と配置:**
  - スライサーにインポートした際、サポート材が最も少なくなる安定した面が「底面（Z=0）」になるように配置してください。
  - スライサーでの中心合わせを容易にするため、XY平面においてはモデルの中心が原点（0, 0）付近にくるように設計してください。
- **パラメーター化:** マジックナンバーを避け、寸法や設定値は必ずファイルの冒頭で定数（大文字）として定義してください。
- **公差（クリアランス）と材質:**
  - パーツの嵌合がある場合は、物理的な収縮を考慮し、クリアランス用の変数を設けて設計してください。
  - 基準値の目安: PLAなどは 0.15mm〜0.2mm。PETGなど粘り気のある材質は少し広め（0.3mm〜0.4mm）にするなど、材質特性に応じて調整してください。
  - 実寸合わせが必要そうなものは、そのパーツ部分だけを最小限切り出したテストモデルの提案・作成をしてください。
- **堅牢なエッジ選択:** `fillet` や `chamfer` 適用時、形状変化によってエッジ選択（`"|Z"`など）が失敗しないよう、形状に依存しにくい堅牢なセレクター（`"not #Z"` など）を心がけてください。

## 3Dプリントへの最適化

- **オーバーハング:** サポート材を減らすため、45度〜55度を超えるオーバーハングを避けるか、面取り（Chamfer）を活用して緩やかに立ち上げてください。
- **ブリッジ:** 水平な面を作る際は、短い距離であればブリッジで対応可能な形状を検討してください。理想的には 45度以上のテーパーを設けるのがベストです。
- **強度と品質:**
  - 応力が集中する角にはフィレット（R付け）を行い、割れを防いでください。
  - 設置面積が小さいモデルは、反り（Warping）を防ぐために底面に十分な面積を持たせるか、スライサーでのブリム併用を考慮してください。

## ソースファイルへのコメント

- CadQueryコードは「設計図」です。意図が伝わりやすくメンテナンスしやすいようにコメントを手厚く書いてください。
- 冒頭のコメントブロック（Docstring）に、**設計要件・推奨フィラメント・印刷統計・履歴への参照**を必ず記載してください。
  - 初回だけではなく、コード変更などに応じて常に更新して正しい内容を保ってください。

### Docstringのテンプレート例

```python
"""
設計要件:
    - [箇条書きで具体的に記載]
    - 最新の3Dプリンター（Bambu Lab P2S 等）での出力を想定。
    - モデルごとに専用ディレクトリで管理し、STEPファイルを出力する。

推奨フィラメント:
    - [材質名] ([理由・特性])
    - [材質名]でも代用可能だが、[用途]の観点から[材質名]を推奨。

印刷統計（予想）:
    - [ファイル名]: 印刷時間 約XX分、フィラメント使用量 約XXg
    - [ファイル名]: 印刷時間 約XX分、フィラメント使用量 約XXg

履歴とプロンプト経緯:
    - 詳細は同ディレクトリの history.md を参照。
"""
```

### 履歴の管理

- 各フォルダの `history.md` に「履歴とプロンプト経緯」を保存・更新してください。
- **履歴は最新のものが一番上にくるように追加・更新してください。**
- ソースファイルからはこの `history.md` を参照するようにしてください。
